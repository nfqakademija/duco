<?php

namespace AppBundle\Repository;

use AppBundle\Entity\AddedResult;
use AppBundle\Entity\Event;
use AppBundle\Entity\Result;
use Doctrine\ORM\Query\Expr\Join;

/**
 * ResultRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ResultRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * @param string $firstName
     * @param string $lastName
     * @return null
     */
    public function getNotAddedResultsByName($firstName, $lastName)
    {
        $qb = $this->getEntityManager()->createQueryBuilder();
        $qb->select(['r', 'e'])
            ->from(Result::class, 'r')
            ->innerJoin(Event::class, 'e', Join::WITH, 'e.id = r.eventId')
            ->leftJoin(AddedResult::class, 'a', Join::WITH, 'a.resultId = r.id')
            ->where('r.firstName LIKE :firstName')
            ->andWhere('r.lastName LIKE :lastName')
            ->andWhere('a.userId IS NULL')
            ->orderBy('r.overallPosition');

        $qb->setParameters([
            'firstName' => $firstName,
            'lastName' => $lastName,
        ]);

        $data = $qb->getQuery()->getResult();

        return $this->groupArrayToEvents($this->cloneArray($data), "AppBundle\\Entity\\Result");
    }

    /**
     * @param int $userId
     * @return null
     */
    public function getAddedResultsByUserId($userId)
    {
        $qb = $this->getEntityManager()->createQueryBuilder();
        $qb->select(['r', 'e'])
            ->from(AddedResult::class, 'r')
            ->innerJoin(Event::class, 'e', Join::WITH, 'e.id = r.eventId')
            ->where('r.userId = :userId')
            ->orderBy('r.overallPosition');
        $qb->setParameters([
            'userId' => $userId,
        ]);
        $data = $qb->getQuery()->getResult();

        return $this->groupArrayToEvents($data, "AppBundle\\Entity\\AddedResult");
    }

    /**
     * @param string $query
     * @return null
     */
    public function getAllResultsBySearchQuery($query)
    {
        $query = strtolower(str_replace(' ', '', $query));
        $qb = $this->getEntityManager()->createQueryBuilder();
        $qb->select(['r', 'e'])
            ->from(Result::class, 'r')
            ->innerJoin(Event::class, 'e', Join::WITH, 'e.id = r.eventId')
            ->where('CONCAT(r.firstName, r.lastName) LIKE :query')
            ->orWhere('r.raceNumber = :query')
            ->orWhere('r.club LIKE :query')
            ->orWhere('r.lastName LIKE :query')
            ->orWhere('r.firstName LIKE :query')
            ->orderBy('r.overallPosition');
        $qb->setParameters([
            'query' => str_replace(' ', '', $query),
        ]);
        $data = $qb->getQuery()->getResult();

        return $this->groupArrayToEvents($data, "AppBundle\\Entity\\Result");
    }

    /**
     * @param array  $data
     * @param string $objectNameToAddToEvent
     * @return null
     */
    private function groupArrayToEvents($data, $objectNameToAddToEvent)
    {
        $events = null;
        $results = null;
        if ($data != null) {
            foreach ($data as $row) {
                if (get_class($row) == $objectNameToAddToEvent) {
                    $results[] = $row;
                } else {
                    $events[$row->getId()] = $row;
                }
            }
            foreach ($results as $result) {
                $events[$result->getEventId()]->addResult($result);
            }
        }

        return $events;
    }

    /**
     * Reikalingas, nes doctrine atiduoda ta pati instance ir nekuria naujo
     *
     * @param array $array
     */
    private function cloneArray($array)
    {
        $clonedData = null;
        foreach ($array as $row) {
            $clonedData[] = clone $row;
        }

        return $clonedData;
    }

    /**
     * Result quantity
     *
     * @return mixed
     */
    public function getResultCount()
    {
        return $this->getEntityManager()
            ->createQuery('SELECT COUNT(r) FROM AppBundle:Result r')
            ->getSingleScalarResult();
    }
}
